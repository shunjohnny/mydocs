---
title: 5.3 CRUDアプリケーションの作成
tags:
  - FastAPI
---

## 5-3-1 アプリケーション作成

|スキーマ|
|---|
|データ構造の定義や形式を規定するための枠組み|

書籍情報を扱うエンドポイントを参考にして、CRUDアプリケーションを作成する
まずはスキーマを定義するファイルを作成する

```python title="book_schemas.py main.pyで使用するスキーマを定義"
from pydantic import BaseModel

class BookSchema(BaseModel):
    title: str
    category: str

class BookResponseSchema(BookSchema):
    id: int
```

データの設定とエンドポイントを定義するmainファイルを作成する

```python title="main.py　エンドポイントポイントの実例"
from fastapi import FastAPI, HTTPException
from book_schemas import BookSchema, BookResponseSchema

app = FastAPI()

# ダミーの書籍情報リスト
books: list[BookResponseSchema] = [
    BookResponseSchema(id="1", title="Python入門", category="technical"),
    BookResponseSchema(id="2", title="初めてのプログラミング", category="technical"),
    BookResponseSchema(id="3", title="進撃の巨人", category="comics"),
    BookResponseSchema(id="4", title="ドラゴンボール", category="comics"),
    BookResponseSchema(id="5", title="週刊文春", category="magazine"),
    BookResponseSchema(id="6", title="autosports", category="magazine"),
]

# ----------------------------------------------------
# エンドポイントの定義
# ----------------------------------------------------


# 書籍を追加するためのエンドポイント
@app.post("/books/", response_model=BookResponseSchema)
def create_book(book: BookSchema):
    new_book_id = max([book.id for book in books], default=0) + 1
    new_book = BookResponseSchema(id=new_book_id, **book.model_dump())
    books.append(new_book)
    return new_book

# 書籍を全県取得するエンドポイント
@app.get("/books/", response_model=list[BookResponseSchema])
def read_books():
    return books

# 書籍情報をidによって1件取得するエンドポイント
@app.get("/books/{book_id}", response_model=BookResponseSchema)
def read_book(book_id: int):
    for book in books:
        if book.id == book_id:
            return book
    raise HTTPException(status_code=404, detail="Book not found")

# idに対応する書籍情報を更新するエンドポイント
@app.put("/books/{book_id}", response_model=BookResponseSchema)
def update_book(book_id: int, book: BookSchema):
    for index, existing_book in enumerate(books):
        if existing_book.id == book_id:
            updated_book = BookResponseSchema(id=book_id, **book.model_dump())
            books[index] = updated_book
            return updated_book
        raise HTTPException(status_code=404, detail="Book not found")

# idに対応する書籍情報を削除するエンドポイント
@app.delete("/books/{book_id}", response_model=BookResponseSchema)
def delete_book(book_id: int):
    for index, book in enumerate(books):
        if book.id == book_id:
            books.pop(index)
            return book
        raise HTTPException(status_code=404, detail="Book not found")
```


||説明|
|---|---|
|response_model|エンドポイントの戻り値を指定するために使用|
|model_dump()|モデルのインスタンスを辞書形式に変換するためのメソッド|
|モデル|BaseModelを継承したクラスを指す|
|フィールド|モデル内で定義された属性|

## 5-3-2 Swaggeer UIでの操作

Swaggerを起動すると下記のように
それぞれのエンドポイントが表示される

![alt text](<../../../images/5.3 CRUDアプリケーションの作成/5.3 CRUDアプリケーションの作成_J0133291.png>)

FastAPIでCRUD処理が作成できたことを確認できる

<br>

## 5-3-3 Pydantic再び

Field関数に関して学ぶ

|Field関数|
|---|
|登録するデータの型を指定し、データのバリデーションルールやメタデータを定義できる|

### 利点

| 利点          | 説明                                          |
|---------------|----------------------------------------------|
| バリデーション | 入力データに対して追加の検証ルールを適用できる    |
| デフォルト値   | フィールドにデフォルト値を設定できる             |
| メタデータ     | フィールドに関する追加情報を提供できる           |
| 説明文         | フィールドに説明を追加してドキュメントが充実する  |

### Field関数の引数項目

| 引数          | 説明                                  |
|---------------|--------------------------------------|
| description   | フィールドの内容を説明                 |
| examples      | フィールドに入力する具体的な例を示す    |
| gt            | greater than                         |
| lt            | less than                            |
| ge            | greater than or equal to             |
| le            | less than or equal to                |
| min_length    | 文字列が指定した最小の長さ以上          |
| max_length    | 文字列が指定した最大の長さ以下          |

### コードを書く

書籍情報を登録するためのFastAPIアプリケーションを作成  
title, category, publish_year, priceというフィールドを定義し、    
Field関数を使用して各フィールドとバリデーションルールを設定する   

```python title="main.py"
from fastapi import FastAPI
from pydantic import BaseModel, Field

app = FastAPI()

# データ構造
class BookSchema(BaseModel):
    # 「...(エリプシスと呼称)」は使用しているフィールドが必須であることを示す
    title: str = Field(..., description="タイトルの指定：必須",
                     example="龍が如く")
    category: str = Field(..., description="カテゴリの指定：必須",
                          example="comics")
    publish_year: int = Field(default=None, description="出版年の指定：任意",
                              example=2023)
    price: float = Field(..., gt=0, le=5000,
                         description="価格の指定：0 < 価格 <= 10000：必須",
                         example=2500)

# エンドポイント
@app.post("/books/", response_model=BookSchema)
async def create_book(book: BookSchema):
    return book
```

<br>

## 5-3-4 Swagger UIでの操作

Swagger UIを起動して確認する

|Example Value|Schema|
|---|---|
|![alt text](<../../../images/5.3 CRUDアプリケーションの作成/5.3 CRUDアプリケーションの作成_J0133291-1.png>)|![alt text](<../../../images/5.3 CRUDアプリケーションの作成/5.3 CRUDアプリケーションの作成_J0133291-2.png>)|
|Field関数で設定した値が表示される|Field関数で設定した条件が確認できる|

try it outからRequest bodyの中身を行単位で削除してExcuteした場合、   
任意項目はnullに変化するが、
必須項目は422エラーが発生