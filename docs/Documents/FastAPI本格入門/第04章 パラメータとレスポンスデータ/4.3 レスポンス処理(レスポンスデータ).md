---
title: 4.3 リクエスト処理(クエリパラメータ)
tags:
  - FastAPI
---

## 4-3-1 レスポンスデータの構造

|レスポンスデータ|
|---|
|APIのエンドポイントからの出力<br>クライアントがリクエストに対して受け取る情報の形と内容を定義<br>通常JSON形式で送信される|


APIのレスポンスデータ構造の注意点：  
「一度のリクエストで必要な情報を簡潔に提供できる構造にする」

|理由|説明|
|---|---|
|効率性の向上|追加リクエストが不要なため、データの取得が早くなるため|
|usabilityの向上|必要な情報をすぐ取得できるため|
|リソースの節約|サーバーとクライアント間の通信回数が減るため|

<br>

## 4-3-2 イメージで振り返る

<figure markdown="span">
  ![alt text](<../../../images/4.3 レスポンス処理(レスポンスデータ)/4.3 レスポンス処理(レスポンスデータ)_J0133291.png>){width=410}
  <figconfig>リクエストとレスポンスのまとめ</figconfig>
</figure>

|項目|説明|
|---|---|
|パスパラメータ|例：/users/{id}の{di}|
|クエリパラメータ|例：/users?age=30のage|
|レスポンスパラメータ|サーバーがクライアントに返すデータ|

## 4-3-3 Pydanticとは？

|pydantic|
|---|
|Pythonでのデータ変換とバリデーション(検証)を簡単にするためのライブラリ<br>型ヒントを用いてデータモデルを定義し、<br>受け取ったデータがその型や条件にあっているか自動でチェックし、データを格納<br>FastAPIとの相性が抜群|

<figure markdown="span">
  ![alt text](<../../../images/4.3 レスポンス処理(レスポンスデータ)/4.3 レスポンス処理(レスポンスデータ)_J0133291-1.png>){width=410}
  <figconfig>pydanticの使用箇所</figconfig>
</figure>

実際にpydanticの使用例を確認してみる  
ここでは型チェック結果で動く場合とエラーが発生する場合を確認

- 問題なく動く場合

    ```python title="main.py"
    from datetime import datetime
    from pydantic import BaseModel, ValidationError

    class Event(BaseModel):
        name: str = "未定"
        start_datetime: datetime
        participants: list[str] = []

    external_data = {
        "name": "FastAPI勉強会",
        "start_datetime": "2023-07-07 07:00",
        "participants": {"山田","スズキ","田中"}
    }

    try:
        event = Event(**external_data)
        print("イベント名：", event.name, type(event.name))
        print("開催日時：", event.start_datetime, type(event.start_datetime))
        print("参加者：", event.participants, type(event.participants))
    except ValidationError as e:
        print("データのバリデーションエラーが発生しました：", e.errors())
    ```

    pydanticのBaseModelを継承したクラス(Event)を作成、型クラスを使用して各変数を定義  
    適切な型のデータを入力すると下記のように問題なく出力される

    ```powershell title="実行結果"
    イベント名： FastAPI勉強会 <class 'str'>
    開催日時： 2023-07-07 07:00:00 <class 'datetime.datetime'>
    参加者： ['山田', 'スズキ', '田中'] <class 'list'>
    ```

- エラーが発生する場合

    ```python title="main.py start_datetimeの値をstrに変更"
    "start_datetime": "abc",
    ```

    ```powershell title="実行結果"
    データのバリデーションエラーが発生しました： [{'type': 'datetime_from_date_parsing', 'loc': ('start_datetime',), 'msg': 'Input should be a valid datetime or date, input is too short', 'input': 'abc', 'ctx': {'error': 'input is too short'}, 'url': 'https://errors.pydantic.dev/2.9/v/datetime_from_date_parsing'}]
    ```

<figure markdown="span">
  ![alt text](<../../../images/4.3 レスポンス処理(レスポンスデータ)/4.3 レスポンス処理(レスポンスデータ)_J0133291-2.png>){width=410}
  <figconfig>pydanticのマインドマップ</figconfig>
</figure>