---
title: 6.2 FastAPIでの非同期処理
tags:
  - FastAPI
---

## httpxのインストール

|項目|requests|httpx|
|---|---|---|
|処理方式|同期処理専用|同期&非同期処理対応|
|HTTP/2対応|なし|あり|
|速度|シンプルな分少し遅め|非同期なら効率的|
|使い所|簡単な同期タスク向き|非同期アプリや複雑な処理向き|

## 「httpx」を使用するプログラム

郵便番号を入力して情報を取るapiに対して、  
httpxを使用して非同期に外部にリクエストを送る

```python title="main.py 郵便番号を入力して情報を取るapiを非同期タスクで行う"
from fastapi import FastAPI
import asyncio
import httpx

app = FastAPI()

async def fetch_address(zip_code: str):
    async with httpx.AsyncClient() as client:  # httpx.AsyncClient():非同期HTTPリクエストをおくるためのクライント
        response = await client.get(
            f"https://zipcloud.ibsnet.co.jp/api/search?zipcode={zip_code}"
            )
        return response.json()

@app.get("/addresses/")
async def get_addresses():
    zip_codes = ['0600000', '1000001', '9000000']
    return await asyncio.gather(*(fetch_address(zip_code) for zip_code in zip_codes))
```

Swagger UIにて実行結果を確認する

```bash title="での実行結果"
[
  {
    "message": null,
    "results": [
      {
        "address1": "北海道",
        "address2": "札幌市中央区",
        "address3": "",
        "kana1": "ﾎｯｶｲﾄﾞｳ",
        "kana2": "ｻｯﾎﾟﾛｼﾁｭｳｵｳｸ",
        "kana3": "",
        "prefcode": "1",
        "zipcode": "0600000"
      }
    ],
    "status": 200
  },
  {
    "message": null,
    "results": [
      {
        "address1": "東京都",
        "address2": "千代田区",
        "address3": "千代田",
        "kana1": "ﾄｳｷｮｳﾄ",
        "kana2": "ﾁﾖﾀﾞｸ",
        "kana3": "ﾁﾖﾀﾞ",
        "prefcode": "13",
        "zipcode": "1000001"
      }
    ],
    "status": 200
  },
  {
    "message": null,
    "results": [
      {
        "address1": "沖縄県",
        "address2": "那覇市",
        "address3": "",
        "kana1": "ｵｷﾅﾜｹﾝ",
        "kana2": "ﾅﾊｼ",
        "kana3": "",
        "prefcode": "47",
        "zipcode": "9000000"
      }
    ],
    "status": 200
  }
]
```