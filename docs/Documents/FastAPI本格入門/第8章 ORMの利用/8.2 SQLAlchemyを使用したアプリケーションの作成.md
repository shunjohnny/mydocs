---
title: 8.2 SQLAlchemyã‚’ä½¿ç”¨ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ
tags:
  - FastAPI
---

## 8-2-1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
å®Ÿéš›ã«SQLAlchemyã‚’ä½¿ç”¨ã—ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã™ã‚‹

### ã‚³ãƒ¼ãƒ‰ã®ä½œæˆ

```python title="main.py"
import os
import asyncio
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from sqlalchemy import Column, Integer, String, select

# ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã®å®šç¾©
Base = declarative_base()

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
base_dir = os.path.dirname(__file__)
DATABASE_URL = 'sqlite+aiosqlite:///' + os.path.join(base_dir, 'example.sqlite')

#==============ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤==============
# éåŒæœŸã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œæˆ
engine = create_async_engine(DATABASE_URL, echo=True)

# éåŒæœŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆ
async_session = sessionmaker(
    engine,
    expire_on_commit=False,
    class_=AsyncSession
)


#==============ãƒ¢ãƒ‡ãƒ«å±¤==============
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ã®å®šç¾©
class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String)


#==============æ©Ÿèƒ½å±¤==============
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–é–¢æ•°
async def init_db():
    print("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™ã€‚")
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)
        print("æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚")
        await conn.run_sync(Base.metadata.create_all)
        print("æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸã€‚")

# ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ é–¢æ•°
async def add_user(name):
    print(f"{name}ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ ã—ã¾ã™ã€‚")
    async with async_session() as session:
        async with session.begin():
            user = User(name=name)
            session.add(user)
            print(f"{name}ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ ã—ã¾ã—ãŸã€‚")

# ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—é–¢æ•°
async def get_users():
    print("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã—ã¾ã™ã€‚")
    async with async_session() as session:
        result = await session.execute(select(User))
        users = result.scalars().all()
        print("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å–å¾—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚")
        return users


#==============ãƒ¡ã‚¤ãƒ³å‡¦ç†==============
async def main():
    await init_db()
    await add_user("ç”°ä¸­")
    await add_user("éˆ´æœ¨")
    users = await get_users()
    for user in users:
        print(f"{user.id}: {user.name}")

asyncio.run(main())
```

### ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ 

```mermaid
graph TB
    %% ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
    classDef primary fill:#FF6B6B,color:#fff,stroke:#FF8787,stroke-width:2px
    classDef secondary fill:#4ECDC4,color:#fff,stroke:#6EE7DF,stroke-width:2px
    classDef accent1 fill:#FFE66D,color:#333,stroke:#FFF3A3,stroke-width:2px
    classDef accent2 fill:#7966FF,color:#fff,stroke:#9C8FFF,stroke-width:2px
    classDef accent3 fill:#FF8364,color:#fff,stroke:#FFA68D,stroke-width:2px

    subgraph DB["ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤"]
        engine["AsyncEngine<br/>begin()<br/>connect()"]
        session["AsyncSession<br/>begin()<br/>execute()"]
    end

    subgraph Model["ğŸ“¦ ãƒ¢ãƒ‡ãƒ«å±¤"]
        base["Base Model<br/>(declarative_base)"]
        user["User Model<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>ğŸ”‘ id: Integer<br/>ğŸ‘¤ name: String"]
    end

    subgraph Func["âš¡ æ©Ÿèƒ½å±¤"]
        init["init_db()"]
        add["add_user()"]
        get["get_users()"]
    end

    base --> user
    Func --> session
    session --> engine
    Func --> user

    %% ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
    class engine,session primary
    class base,user secondary
    class init accent1
    class add accent2
    class get accent3

    %% æ¥ç¶šç·šã®ã‚¹ã‚¿ã‚¤ãƒ«
    linkStyle default stroke:#6C6F93,stroke-width:2px,stroke-dasharray: 5 5
```

### ã‚³ãƒ¼ãƒ‰ã®è§£èª¬

<div class="chat-container">
  <!-- ãšã‚“ã ã‚‚ã‚“ã®è³ªå• -->
  <div class="chat right">
    <div class="chat-message zundamon-message">
      SQLAlchemyã®éåŒæœŸå‡¦ç†ã£ã¦é›£ã—ãã†ãªã®ã ...<br>
      ä½•ã‚’ã‚„ã£ã¦ã‚‹ã®ã‹ã‚ã‹ã‚‰ãªã„ã®ã ...
    </div>
    <img src="../../../images/2.1 æ¦‚è¦/2.1 æ¦‚è¦_J0133291-2.png" alt="ãšã‚“ã ã‚‚ã‚“" class="avatar">
  </div>

  <!-- æ˜¥æ—¥éƒ¨ã¤ã‚€ãã®å›ç­” -->
  <div class="chat left">
    <img src="../../../images/2.2 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€/2.2 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€_J0133291-15.png" alt="æ˜¥æ—¥éƒ¨ã¤ã‚€ã" class="avatar">
    <div class="chat-message tsumugi-message">
      ã‚ï½ã€ç¢ºã‹ã«ã¡ã‚‡ã£ã¨ã‚„ã‚„ã“ã—ã„ã‚ˆã­ğŸ’¦<br>
      ã¾ãšã¯å¤§ãã3ã¤ã®å±¤ã«åˆ†ã‹ã‚Œã¦ã‚‹ã‚“ã ï¼<br>
      1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤ï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®é€šä¿¡ã‚’ç®¡ç†<br>
      2. ãƒ¢ãƒ‡ãƒ«å±¤ï¼šãƒ‡ãƒ¼ã‚¿ã®å½¢ã‚’å®šç¾©<br>
      3. æ©Ÿèƒ½å±¤ï¼šå®Ÿéš›ã®æ“ä½œã‚’è¡Œã†<br>
      ã“ã‚Œã‚’é †ç•ªã«è¦‹ã¦ã„ã“ã†ã‹ï¼âœ¨
    </div>
  </div>

  <div class="chat right">
    <div class="chat-message zundamon-message">
      ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤ã£ã¦ãªã‚“ãªã®ã ï¼ŸğŸ¤”
    </div>
    <img src="../../../images/2.1 æ¦‚è¦/2.1 æ¦‚è¦_J0133291-8.png" alt="ãšã‚“ã ã‚‚ã‚“" class="avatar">
  </div>

  <div class="chat left">
    <img src="../../../images/2.1 æ¦‚è¦/2.1 æ¦‚è¦_J0133291-3.png" alt="æ˜¥æ—¥éƒ¨ã¤ã‚€ã" class="avatar">
    <div class="chat-message tsumugi-message">
      ãˆã¸ã¸ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ãŠè©±ã™ã‚‹ãŸã‚ã®æº–å‚™ã‚’ã™ã‚‹éƒ¨åˆ†ãªã®ï¼
      <pre><code>engine = create_async_engine(DATABASE_URL, echo=True)
async_session = sessionmaker(
    engine,
    expire_on_commit=False,
    class_=AsyncSession
)</code></pre>
      ã“ã“ã§ã¯2ã¤ã®å¤§åˆ‡ãªã‚‚ã®ã‚’ä½œã£ã¦ã‚‹ã®ï¼š<br>
      1. engineï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®é€šä¿¡è·¯ã‚’ä½œã‚‹ã‚ˆï¼<br>
      2. async_sessionï¼šå®Ÿéš›ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚„ã‚Šå–ã‚Šã™ã‚‹çª“å£ãªã®ï¼<br>
      éåŒæœŸå‡¦ç†ã ã‹ã‚‰ã€ä»–ã®ä½œæ¥­ã‚’ã—ãªãŒã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ãŠè©±ã§ãã‚‹ã‚“ã ï¼
    </div>
  </div>

  <div class="chat right">
    <div class="chat-message zundamon-message">
      ãƒ¢ãƒ‡ãƒ«å±¤ã¯ã©ã‚“ãªã“ã¨ã‚’ã™ã‚‹ã®ã ï¼ŸğŸ“¦<br>
      ãªã‚“ã§ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã†ã®ã ï¼Ÿ
    </div>
    <img src="../../../images/2.1 æ¦‚è¦/2.1 æ¦‚è¦_J0133291-8.png" alt="ãšã‚“ã ã‚‚ã‚“" class="avatar">
  </div>

  <div class="chat left">
    <img src="../../../images/2.1 æ¦‚è¦/2.1 æ¦‚è¦_J0133291.png" alt="æ˜¥æ—¥éƒ¨ã¤ã‚€ã" class="avatar">
    <div class="chat-message tsumugi-message">
      ãƒ¢ãƒ‡ãƒ«å±¤ã¯ã€ãƒ‡ãƒ¼ã‚¿ã®è¨­è¨ˆå›³ã¿ãŸã„ãªã‚‚ã®ãªã®ï¼
      <pre><code>class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True)
    name = Column(String)</code></pre>
      ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã†ç†ç”±ã¯3ã¤ã‚ã‚‹ã‚“ã ã‚ˆï¼š<br>
      1. ãƒ‡ãƒ¼ã‚¿ã®å½¢ã‚’åˆ†ã‹ã‚Šã‚„ã™ãå®šç¾©ã§ãã‚‹<br>
      2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ç°¡å˜ã«å¯¾å¿œã¥ã‘ã‚‰ã‚Œã‚‹<br>
      3. Pythonã‚‰ã—ã„æ›¸ãæ–¹ãŒã§ãã‚‹ï¼<br><br>
      
      ä¾‹ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã•ã‚“ã®å ´åˆï¼š<br>
      - ãƒ†ãƒ¼ãƒ–ãƒ«åã¯'users'<br>
      - idã¯è‡ªå‹•ã§å¢—ãˆã‚‹ç•ªå·<br>
      - nameã¯æ–‡å­—åˆ—ã§ä¿å­˜<br>
      ã£ã¦æ„Ÿã˜ã§æ±ºã‚ã‚‰ã‚Œã‚‹ã‚“ã ï¼âœ¨
    </div>
  </div>
<div class="chat-container">
  <!-- ãšã‚“ã ã‚‚ã‚“ã®è³ªå• -->
  <div class="chat right">
    <div class="chat-message zundamon-message">
      æ©Ÿèƒ½å±¤ã§ã¯ä½•ã‚’ã™ã‚‹ã®ã ï¼ŸğŸ¤”<br>
      asyncã¨awaitãŒã„ã£ã±ã„å‡ºã¦ãã‚‹ã®ã ï¼
    </div>
    <img src="../../../images/2.1 æ¦‚è¦/2.1 æ¦‚è¦_J0133291-4.png" alt="ãšã‚“ã ã‚‚ã‚“" class="avatar">
  </div>

  <!-- æ˜¥æ—¥éƒ¨ã¤ã‚€ãã®å›ç­” -->
  <div class="chat left">
    <img src="../../../images/2.1 æ¦‚è¦/2.1 æ¦‚è¦_J0133291-5.png" alt="æ˜¥æ—¥éƒ¨ã¤ã‚€ã" class="avatar">
    <div class="chat-message tsumugi-message">
      æ©Ÿèƒ½å±¤ãŒä¸€ç•ªæ¥½ã—ã„ã¨ã“ã‚ãªã®ï¼å®Ÿéš›ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ã†éƒ¨åˆ†ã ã‚ˆï¼<br><br>
      
      3ã¤ã®å¤§åˆ‡ãªé–¢æ•°ãŒã‚ã‚‹ã®ï¼š
      <pre><code>async def init_db():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

async def add_user(name):
    async with async_session() as session:
        async with session.begin():
            session.add(User(name=name))

async def get_users():
    async with async_session() as session:
        result = await session.execute(select(User))
        return result.scalars().all()</code></pre>

      asyncã¨awaitã¯éåŒæœŸå‡¦ç†ã®é­”æ³•ãªã®ï¼âœ¨<br>
      ä¾‹ãˆã°ã€ã“ã‚“ãªæ„Ÿã˜ã§ä¾¿åˆ©ãªã®ï¼š<br>
      - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå‡¦ç†ã—ã¦ã‚‹é–“ã«ä»–ã®ä½œæ¥­ãŒã§ãã‚‹<br>
      - ãŸãã•ã‚“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒæ™‚ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚å¤§ä¸ˆå¤«<br>
      - ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒæ­¢ã¾ã‚‰ãšã«ã‚¹ãƒ ãƒ¼ã‚ºã«å‹•ã<br>
    </div>
  </div>

  <!-- ãšã‚“ã ã‚‚ã‚“ã®è³ªå• -->
  <div class="chat right">
    <div class="chat-message zundamon-message">
      æ©Ÿèƒ½å±¤ã®ã¨ã“ã‚ã‚’ã‚‚ã£ã¨è©³ã—ãæ•™ãˆã¦ã»ã—ã„ã®ã ï¼<br>
      ãã‚Œãã‚Œã®é–¢æ•°ãŒä½•ã‚’ã—ã¦ã„ã‚‹ã®ã‹åˆ†ã‹ã‚‰ãªã„ã®ã ...ğŸ¤”
    </div>
    <img src="../../../images/2.1 æ¦‚è¦/2.1 æ¦‚è¦_J0133291-2.png" alt="ãšã‚“ã ã‚‚ã‚“" class="avatar">
  </div>

  <!-- æ˜¥æ—¥éƒ¨ã¤ã‚€ãã®å›ç­” -->
  <div class="chat left">
    <img src="../../../images/2.1 æ¦‚è¦/2.1 æ¦‚è¦_J0133291-5.png" alt="æ˜¥æ—¥éƒ¨ã¤ã‚€ã" class="avatar">
    <div class="chat-message tsumugi-message">
      ã†ã‚“ã†ã‚“ï¼æ©Ÿèƒ½å±¤ã®é–¢æ•°ã‚’1ã¤ãšã¤è©³ã—ãèª¬æ˜ã™ã‚‹ã­ï¼âœ¨
    </div>
  </div>

  <!-- æ˜¥æ—¥éƒ¨ã¤ã‚€ãã®å›ç­”: init_dbé–¢æ•° -->
  <div class="chat left">
    <img src="../../../images/2.1 æ¦‚è¦/2.1 æ¦‚è¦_J0133291-5.png" alt="æ˜¥æ—¥éƒ¨ã¤ã‚€ã" class="avatar">
    <div class="chat-message tsumugi-message">
      ã¾ãšã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°ã‚’è¦‹ã¦ã¿ã‚ˆã†ï¼
      <pre><code>async def init_db():
    print("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™")
    async with engine.begin() as conn:
        # æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤
        await conn.run_sync(Base.metadata.drop_all)
        print("æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
        
        # æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
        await conn.run_sync(Base.metadata.create_all)
        print("æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ")
</code></pre>

       ã“ã®é–¢æ•°ã§ã¯3ã¤ã®å¤§åˆ‡ãªã“ã¨ã‚’ã—ã¦ã‚‹ã®ï¼š<br>
       1. engineã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶š<br>
       2. å¤ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®‰å…¨ã«å‰Šé™¤<br>
       3. æ–°ã—ã„ç©ºã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ<br><br>
      
       async withã‚’ä½¿ã†ã“ã¨ã§ã€æ¥ç¶šã®é–‹å§‹ã¨çµ‚äº†ã‚’è‡ªå‹•ã§ç®¡ç†ã§ãã‚‹ã‚“ã ï¼
    </div>
  </div>

  <!-- ãšã‚“ã ã‚‚ã‚“ã®è³ªå• -->
  <div class="chat right">
    <div class="chat-message zundamon-message">
      ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°ã¯ã©ã†ãªã£ã¦ã‚‹ã®ã ï¼ŸğŸ¤”
    </div>
    <img src="../../../images/2.1 æ¦‚è¦/2.1 æ¦‚è¦_J0133291-8.png" alt="ãšã‚“ã ã‚‚ã‚“" class="avatar">
  </div>

  <!-- æ˜¥æ—¥éƒ¨ã¤ã‚€ãã®å›ç­” -->
  <div class="chat left">
    <img src="../../../images/2.1 æ¦‚è¦/2.1 æ¦‚è¦_J0133291.png" alt="æ˜¥æ—¥éƒ¨ã¤ã‚€ã" class="avatar">
    <div class="chat-message tsumugi-message">
      ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°ã¯ã“ã‚“ãªæ„Ÿã˜ã ã‚ˆï¼
      <pre><code>async def add_user(name):
    print(f"{name}ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ ã—ã¾ã™")
    async with async_session() as session:
        async with session.begin():
            # æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
            user = User(name=name)
            # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ 
            session.add(user)
            print(f"{name}ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ ã—ã¾ã—ãŸ")
</code></pre>

      ã“ã®é–¢æ•°ã§ã‚„ã£ã¦ã‚‹ã“ã¨ã¯ï¼š<br>
      1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®ä¼šè©±ã‚’å§‹ã‚ã‚‹ï¼‰<br>
      2. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ï¼ˆå¤‰æ›´ã‚’å®‰å…¨ã«è¡Œã†ãŸã‚ã®ä»•çµ„ã¿ï¼‰<br>
      3. Userã‚¯ãƒ©ã‚¹ã§æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ<br>
      4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜<br><br>

      äºŒé‡ã®`async with`ã‚’ä½¿ã†ã“ã¨ã§ï¼š<br>
      - ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚å®‰å…¨<br>
      - è‡ªå‹•ã§ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã‚Œã‚‹<br>
      - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚‚è‡ªå‹•ã§é–‰ã˜ã¦ãã‚Œã‚‹<br>
      ã™ã”ãä¾¿åˆ©ãªã‚“ã ï¼âœ¨
    </div>
  </div>

  <!-- ãšã‚“ã ã‚‚ã‚“ã®è³ªå• -->
  <div class="chat right">
    <div class="chat-message zundamon-message">
      ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã«ã¤ã„ã¦ã‚‚è©³ã—ãçŸ¥ã‚ŠãŸã„ã®ã ï¼
    </div>
    <img src="../../../images/2.1 æ¦‚è¦/2.1 æ¦‚è¦_J0133291-8.png" alt="ãšã‚“ã ã‚‚ã‚“" class="avatar">
  </div>

  <!-- æ˜¥æ—¥éƒ¨ã¤ã‚€ãã®å›ç­” -->
  <div class="chat left">
    <img src="../../../images/2.1 æ¦‚è¦/2.1 æ¦‚è¦_J0133291.png" alt="æ˜¥æ—¥éƒ¨ã¤ã‚€ã" class="avatar">
    <div class="chat-message tsumugi-message">
      ã†ã‚“ï¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã‚’è¦‹ã¦ã¿ã‚ˆã†ï¼
      <pre><code>async def get_users():
    print("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã—ã¾ã™")
    async with async_session() as session:
        # SQLAlchemyã®SELECTæ–‡ã‚’ä½œæˆ
        stmt = select(User)
        # ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
        result = await session.execute(stmt)
        # çµæœã‚’å–å¾—
        users = result.scalars().all()
        print("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å–å¾—ãŒå®Œäº†ã—ã¾ã—ãŸ")
        return users
</code></pre>

      ã“ã®é–¢æ•°ã§ã¯ï¼š<br>
      1. `select(User)`ã§SQLã®SELECTæ–‡ã‚’ä½œæˆ<br>
      2. `session.execute()`ã§ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ<br>
      3. `scalars().all()`ã§çµæœã‚’Pythonã®ãƒªã‚¹ãƒˆã«å¤‰æ›<br><br>

      ã“ã“ã§ã®ãƒã‚¤ãƒ³ãƒˆã¯ï¼š<br>
      - SQLã‚’ç›´æ¥æ›¸ã‹ãªãã¦ã‚‚å¤§ä¸ˆå¤«ï¼<br>
      - çµæœã¯æ™®é€šã®Pythonã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦æ‰±ãˆã‚‹<br>
      - async/awaitã®ãŠã‹ã’ã§éåŒæœŸå‡¦ç†ãŒã§ãã‚‹<br>
      
      ã ã‹ã‚‰ã€ã“ã‚“ãªæ„Ÿã˜ã§ç°¡å˜ã«ä½¿ãˆã‚‹ã®ï¼š
      <pre><code>users = await get_users()
for user in users:
    print(f"ID: {user.id}, Name: {user.name}")
</code></pre>
    </div>
  </div>

  <!-- ãšã‚“ã ã‚‚ã‚“ã®è³ªå• -->
  <div class="chat right">
    <div class="chat-message zundamon-message">
      å…¨éƒ¨ã¾ã¨ã‚ã‚‹ã¨ã©ã†ãªã‚‹ã®ã ï¼ŸğŸŒŸ
    </div>
    <img src="../../../images/2.1 æ¦‚è¦/2.1 æ¦‚è¦_J0133291-2.png" alt="ãšã‚“ã ã‚‚ã‚“" class="avatar">
  </div>

  <!-- æ˜¥æ—¥éƒ¨ã¤ã‚€ãã®å›ç­” -->
  <div class="chat left">
    <img src="../../../images/2.1 æ¦‚è¦/2.1 æ¦‚è¦_J0133291-5.png" alt="æ˜¥æ—¥éƒ¨ã¤ã‚€ã" class="avatar">
    <div class="chat-message tsumugi-message">
      ãˆã¸ã¸ã€å…¨éƒ¨ã¾ã¨ã‚ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚‹ã®ï¼
      <pre><code>async def main():
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æº–å‚™
    await init_db()  # ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã‚‹ã‚ˆï¼

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã•ã‚“ã‚’è¿½åŠ 
    await add_user("ç”°ä¸­")  # ç”°ä¸­ã•ã‚“ã€ã„ã‚‰ã£ã—ã‚ƒã„ï¼
    await add_user("éˆ´æœ¨")  # éˆ´æœ¨ã•ã‚“ã‚‚ã€ã©ã†ãï¼

    # ç™»éŒ²ã•ã‚ŒãŸäººã‚’ç¢ºèª
    users = await get_users()
    for user in users:
        print(f"{user.id}: {user.name}")
</code></pre>

      ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ç‰¹å¾´ã¯ï¼š<br>
      1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æº–å‚™ã‹ã‚‰ä½¿ç”¨ã¾ã§å…¨éƒ¨éåŒæœŸ<br>
      2. ã‚³ãƒ¼ãƒ‰ãŒã¨ã£ã¦ã‚‚ã‚¹ãƒƒã‚­ãƒªã—ã¦ã‚‹<br>
      3. ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚å®‰å…¨ã«å‡¦ç†ã§ãã‚‹<br><br>

      éåŒæœŸå‡¦ç†ã®ãŠã‹ã’ã§ã€ã¨ã£ã¦ã‚‚ã‚¹ãƒ ãƒ¼ã‚ºã«å‹•ãã‚“ã ï¼âœ¨<br>
      ä½•ã‹åˆ†ã‹ã‚‰ãªã„ã“ã¨ãŒã‚ã£ãŸã‚‰ã€ã¾ãŸèã„ã¦ã­ï¼ãˆã¸ã¸ğŸ˜Š
    </div>
  </div>
</div>
</div>

## 8-2-2 å‹•ä½œç¢ºèªã®å®Ÿæ–½

å®Ÿè¡Œã™ã‚‹ã¨ä¸‹è¨˜ã®ã‚ˆã†ã«ã€ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ãŒè¡Œã‚ã‚Œã€ãƒ‡ãƒ¼ã‚¿ãŒè¿½åŠ ã•ã‚Œã€  
ä¸€è¦§ã‚’å–å¾—å‡¦ç†ãŒã‚¿ãƒ¼ãƒŸãƒŠãƒ«ä¸Šã§ç¢ºèªã§ãã‚ã‚‹ã€‚  
ã¾ãŸã€SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã‚‹ã€‚

```bash title="å‡ºåŠ›çµæœ"
2024-11-21 15:51:13,574 INFO sqlalchemy.engine.Engine [no key 0.00009s] ()
æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸã€‚
2024-11-21 15:51:13,581 INFO sqlalchemy.engine.Engine COMMIT
ç”°ä¸­ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ ã—ã¾ã™ã€‚
ç”°ä¸­ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ ã—ã¾ã—ãŸã€‚
2024-11-21 15:51:13,583 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2024-11-21 15:51:13,584 INFO sqlalchemy.engine.Engine INSERT INTO users (name) VALUES (?)
2024-11-21 15:51:13,584 INFO sqlalchemy.engine.Engine [generated in 0.00013s] ('ç”°ä¸­',)
2024-11-21 15:51:13,585 INFO sqlalchemy.engine.Engine COMMIT
éˆ´æœ¨ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ ã—ã¾ã™ã€‚
éˆ´æœ¨ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ ã—ã¾ã—ãŸã€‚
2024-11-21 15:51:13,593 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2024-11-21 15:51:13,593 INFO sqlalchemy.engine.Engine INSERT INTO users (name) VALUES (?)
2024-11-21 15:51:13,593 INFO sqlalchemy.engine.Engine [cached since 0.009258s ago] ('éˆ´æœ¨',)
2024-11-21 15:51:13,594 INFO sqlalchemy.engine.Engine COMMIT
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã—ã¾ã™ã€‚
2024-11-21 15:51:13,601 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2024-11-21 15:51:13,602 INFO sqlalchemy.engine.Engine SELECT users.id, users.name 
FROM users
2024-11-21 15:51:13,603 INFO sqlalchemy.engine.Engine [generated in 0.00016s] ()
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å–å¾—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚
2024-11-21 15:51:13,604 INFO sqlalchemy.engine.Engine ROLLBACK
1: ç”°ä¸­
2: éˆ´æœ¨
```