---
title: 7.2 AppルーターとAPI
tags:
  - Next.js
---

## AppルーターにおけるAPIとルートハンドラ

Appルーターの場合はpagesルーターと異なり、apiフォルダが存在せず、  
「ルートハンドラ」を使用して処理を行う

### ルートハンドラについて

|ルートハンドラ|
|---|
|クライントからのリクエストをハンドリングするためのもの<br>送られるリクエストのHTTPメソッドごとに関数として実装される|

```typescript title="「GET」ルートハンドラの基本形"
export async function GET(request: Request) {
    ---処理を用意---
    return 《Response》
}
```

<br>

上記コードの中のResponseは下記のように作成する

```typescript title="Responseの作成"
new Response( コンテンツ, 設定 )
```

- 第1引数に、コンテンツとして返送するstring値を指定する  
  オブジェクト等を返送する場合は、JSON.stringifyなどでstringに変換して渡す

- 第2引数に、送信に関する各種の設定をオブジェクトにまとめたものを用意

```typescript title="Responseの第2引数の例"
{
    status: コード番号,
    headers: {---ヘッダーの設定---}
}
```

<br>

## GETメソッドのルートハンドラを作る

ルートハンドラは、フォルダごとにroute.tsという名前で作成  
そのフォルダーのパスにアクセスすると実行される

!!! tips
    route.tsはそのフォルダーのパスにアクセスされると最初に実行される  
    同じ場所にpage.tsxがあってもpage.tsxは呼び出されない

### ルートハンドラを記述する

```typescript title="src/app/rh/route.ts"
"use server"

export async function GET(request: Request) {
    const res = { content:'Hello, this is API content'}
    return new Response(JSON.stringify(res),{
        status: 200,
        header: {'Content-Type': 'application/json'},
    })
}
```

<br>

## コンポーネントからAPIにアクセスする

```typescript title="src/app/page.tsx"
"use client"
import useSWR from 'swr'

const url = '/rh'
const fetcher = (...args) =>
  fetch(...args).then(res => res.json())

export default function Home() {
  const {data, error, isLoading} = useSWR(url, fetcher)
  return (
    <main>
      <h1 className="title">Index page</h1>
      <p className="msg font-bold">※SWRでデータを取得します</p>
      <p className="msg border p-2">
        {error ? 'ERROR!!' : isLoading ?
          'loading...' : data.content}
      </p>
    </main>
  )
}
```

<figure markdown="span">
  ![alt text](<../../../images/7.2 Appルーターとルートパンドラ/7.2 Appルーターとルートパンドラ_J0133291.png>){width="400"}
  <figconfig>実行結果</figconfig>
</figure>

<br>

## IDを渡してアクセスする

sample.jsonにfetchでアクセスしてデータを取得し、  
クエリーパラメーターで渡されたIDのデータを返すAPIを作成する

```typescript title="src/app/rh/route.ts"
"use server"

const url = 'http://localhost:3000/sample.json'

export async function GET(request: Request) {
    //sample.jsonを取得
    const result = await fetch(url, {
        headers: {
            'Content-Type': 'application/json',
        },
    })
    const data = await result.json()

    //パラメータを取得
    const { searchParams } = new URL(request.url)
    var id = +searchParams.get('id')
    id = id < 0 ? 0 : id>= data.data.length ? data.data.length -1 : id

    //データ取得
    const item = data.data[id]

    return new Response(JSON.stringify(item), {
        status: 200,
        headers: { 'Content-Type': 'application/json' },
    })
}
```

<br>

## APIを使って指定IDのデータを表示する

```typescript title="src/app/page.tsx"
"use client"
import { useState } from 'react'
import useSWR from 'swr'

const url = 'http://localhost:3000/rh?id='
const fetcher = (...args) => 
  fetch(...args).then(res => res.json())

export default function Home() {
  const[input, setInput] = useState(0)
  const {data, error, mutate, isLoading} = useSWR(url + input, fetcher)
  const doChange = (event)=> {
    const val = event.target.value
    setInput(val)
    mutate(url + val)
  }
  return (
    <main>
      <h1 className="title">Index page</h1>
      <p className="msg font-bold">※SWRでデータを取得します</p>
      <input type="number" min="0" max="2"
        className="input m-5"
        value={input} onChange={doChange} />
      <p className="msg border p-2">
        {error ? 'ERROR!!' : isLoading ?
          'loading...' : JSON.stringify(data)}
      </p>
    </main>
  )
}
```

<br>

## ファイルアクセスとPOST送信

ファイルに追記するAPIを作成する

```typescript title="src/app/rh/route.ts"
"use server"
import fs from 'fs'

const path = './data.txt'

export async function GET(request: Request) {
    //ファイルを読み込む
    const content = fs.readFileSync(path, {flag:'a+'})
      .toString().trim()
    //読み込んだコンテンツを返す
    return new Response(JSON.stringify({content:content}), {
        status: 200,
        headers: { 'Content-Type': 'application/json' },
    })
}

export async function POST(request: Request) {
    // ボディをJSONオブジェクトで取得
    const body = await request.json()
    // ファイルに追記
    fs.appendFileSync(path, body.content + "\n")
    // Responseを返す
    return new Response(
        JSON.stringify({ content:'ok' }),
        {
            status: 200,
            header: {'Content-Type': 'application/json' },
        }
    )
}
```

### コンポーネントからPOSTする

APIを利用するようにコンポーネントを修正する

```typescript title="src/app/page.tsx"
"use client"
import { useState } from 'react'
import useSWR from 'swr'

const url = 'http://localhost:3000/rh'
const fetcher = (...args) => 
  fetch(...args).then(res => res.json())

export default function Home() {
  const[input, setInput] = useState('')
  const {data, error, mutate, isLoading} = useSWR(url, fetcher)
  const doChange = (event)=> {
    const val = event.target.value
    setInput(val)
    mutate(url)
  }
  const doAction = () => {
    const opts = {
      method:'POST',
      body:JSON.stringify({content:input})
    }
    fetch(url,opts).then(resp=>{
      setInput('')
      mutate(url)
    })
  }
  return (
    <main>
      <h1 className="title">Index page</h1>
      <p className="msg font-bold">※SWRでデータを取得します</p>
      <input type="text" className="input m-5" value={input} onChange={doChange} />
      <button onClick={doAction} className="btn">Click</button>
      <pre className="msg border p-2">
        {error ? 'ERROR!!' : isLoading ?
          'loading...' : data.content}
      </pre>
    </main>
  )
}
```
<figure markdown="span">
  ![alt text](<../../../images/7.2 Appルーターとルートパンドラ/7.2 Appルーターとルートパンドラ_J0133291-1.png>){width="400"}
  <figconfig>textareaに入力してクリックすると、data.txtに保存され、下枠に表示される</figconfig>
</figure>

<br>

## フォーム送信にAPIを使う

```typescript title="src/app/rh/route.ts"
"use server"
import fs from 'fs'

const path = './form.txt'

export async function GET(request: Request) {
  const content = fs.readFileSync(path, {flag:'a+'})
    .toString().trim()
  return new Response(JSON.stringify({content:content.toString()}), {
    status: 200,
    headers: { 'Content-Type': 'application/json' },
  })
}

export async function POST(request: Request) {
  const formData = await request.formData()
  const name = formData.get('name')
  const pass = formData.get('pass')
  const content = "NAME: " + name + "\n" +
    "PASS: " + pass
  fs.writeFileSync(path, content )
  return new Response({status:'ok'})
}
```

### ログインページを作る

```typescript title="src/app/page.tsx"
"use client"
import { useState } from 'react'
import useSWR from 'swr'

const url = 'http://localhost:3000/rh'
const fetcher = (...args) => 
  fetch(...args).then(res => res.json())

export default function Home() {
  const [name,setName] = useState('')
  const [pass,setPass] = useState('')
  const {data,error,mutate,isLoading} = useSWR(url, fetcher)
  const doName = (event)=> {
    const val = event.target.value
    setName(val)
  }
  const doPass = (event)=> {
    const val = event.target.value
    setPass(val)
  }
  async function login(formData: FormData) {
    fetch('/rh', {
      method: 'POST', 
      body: formData
    }).then(response => {
      setName('')
      setPass('')
      mutate()
    })
    .catch(error => {
      console.log(error)
    });
  }
  return (
    <main>
      <h1 className="title">Login page</h1>
      <p className="msg font-bold">
        ※名前とパスワードを入力：</p>
      <form action={login}>
      <div><input type="text" className="input mx-5 my-1"
        name="name" value={name} onChange={doName} /></div>
      <div><input type="password" className="input mx-5 my-1"
        name="pass" value={pass} onChange={doPass} /></div>
      <div className="mx-3"><button className="btn my-1">
        Click</button></div>
      </form>
      <pre className="msg border p-2">
        {error ? 'ERROR!!' : isLoading ? 
          'loading...' : data.content}
      </pre>
    </main>
  )
}
```