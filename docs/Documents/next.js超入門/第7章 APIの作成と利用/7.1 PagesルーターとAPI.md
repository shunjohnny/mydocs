---
title: 7.1 PagesルーターとAPI
tags:
  - Next.js
---

## WebアクセスとAPI

|API|
|---|
|Webアプリケーションの機能や他のプログラムと共有するサービス等を提供するためのインターフェース|

### ルーター方式でAPIは異なる

PagesルーターとAppルーターで実装方法が異なる

<br>

## 「api」フォルダーについて

src/pages/apiにapiのコードをおく  
拡張子は.ts(Typescriptのソースコードを示す)

### APIにアクセスする

初期で入っているhello.tsにアクセスすると、  
下記のテキストが表示される

<figure markdown="span">
   ![alt text](<../../../images/7.1 PagesルーターとAPI/7.1 PagesルーターとAPI_J0133291.png>){width="300"}
   <figconfig>apiへのアクセス結果</figconfig>
</figure>

<br>

## APIの基本コード

hello.tsを確認して、コードの内容を理解していく

```typescript title="src/pages/api/hello.ts"
import type { NextApiRequest, NextApiResponse } from "next";

type Data = {
  name: string;
};

export default function handler(
  req: NextApiRequest,
  res: NextApiResponse<Data>,
) {
  res.status(200).json({ name: "John Doe" });
}
```

### APIオブジェクトのインポート

初めのimportしているオブジェクトは以下のような働きをする

| オブジェクト           | 説明                                                       |
|------------------------|------------------------------------------------------------|
| NextApiRequest         | API用のリクエスト・オブジェクト。<br>クライアントからサーバーに送られてくる情報などを管理|
| NextApiResponse        | API用のレスポンス・オブジェクト。<br>サーバーからクライアントに返送する情報などを管理|

### オブジェクトのタイプ定義

[name: string]というオブジェクトをDataという名前のタイプとして定義

```typescript title="オジェクトのタイプ定義"
type Data = {
    name: string
}
```

### 関数の定義

Next.jsのAPI関数はexport defalut functionで定義され、handlerと名付けるのが一般的

```typescript title="関数の定義"
export default function handler(
    req: NextApiRequest,          //リクエストの引数としてNextApiRequestを定義
    res: NextApiResponse<Data>    //レスポンスの引数としてNextApiResponse<Data>を定義
){
    ---実行内容---
}
```

|ジェネリック型|
|---|
|色々な型に対応できる、カスタマイズ可能な箱。先に定義しておいて、後で決めることができる

`res: NextApiResponse<Data>`の`Data`がジェネリック型に該当し、  
「Data型の値を返送するNextApiResponse」を意味する

### JSONデータを返送する


```typescript title="JSONデータを返送"
res.status(200).json({name: 'John Doe'})
```

status(200) :  
レスポンスのステータスコードを設定するもの  
status(200)は正常にアクセスできたことを示す。  
通常これを設定

json({name: 'John Doe'}) :  
返信データとしてJSONデータを設定するメソッド  
`<Data>`型の値しか利用できない(先にジェネリック型で定義したため)

<br>

## コンポーネントからAPIを利用する

前の章のuseSWRを使用してAPIにアクセスする
hello.tsを使用するコンポーネント

```typescript title="src/pages/index.tsx"
'use client'

import { Inter } from 'next/font/google'
import useSWR from 'swr'

const inter = Inter({subsets: ['latin']})

const url = '/api/hello'
const fetcher = (...args) => 
  fetch(...args).then(res => res.json())

export default function Home() {
  const {data, error, isLoading} = useSWR(url, fetcher)
  return (
    <main>
      <h1 className="header">Index page</h1>
      <p>これは、API利用のサンプルです。</p>
      <p className="border p-3">
        result: {error ? "ERROR!!" : isLoading ? "loading..." : data.name}
      </p>
    </main>
  )
}
```
<figure markdown="span">
  ![alt text](<../../../images/7.1 PagesルーターとAPI/7.1 PagesルーターとAPI_J0133291-1.png>){width=300}
  <figconfig>実行結果</figconfig>
</figure>

<br>

## IDでデータを取得する

例としてIDの値をパラメータで渡すとそのIDのデータを返すAPIを考える

```typescript title="src/pages/api/data/[id].ts"
import type { NextApiRequest, NextApiResponse } from 'next'

type Data = {
    name: string,
    mail: string,
    age: number
}

const data = [
    {"name":"taro", "mail":"taro@yamada","age":"39"},
    {"name":"hanako", "mail":"hanako@flower","age":"28"},
    {"name":"sachiko", "mail":"sachico@happy","age":"17"},
    {"name":"jiro", "mail":"jiro@change","age":"6"}
]

export default function handler(
    req: NextApiRequest,
    res: NextApiResponse<Data>
) {
    var id = +req.query.id
    id = id < 0 ? 0 : id >= data.length ?data.length -1 :id
    const result = data[id]
    res.status(200).json(result)
}
```

<figure markdown="span">
  ![alt text](<../../../images/7.1 PagesルーターとAPI/7.1 PagesルーターとAPI_J0133291-2.png>){width="300"}
  <figconfig>アクセス結果</figconfig>
</figure>

パスやクエリ文字列によって送られたパラメータは、  
NextApiReqyestの「query」というプロパティにオブジェクトとしてまとめられる。  
パスからidというパラメータが渡されているから下記で取り出せる。

```typescript title="送信されたパラメータの値の取り出し"
var id = +req.query.id
```
!!! tips
    +をつけることで、クエリパラメータから受け取ったidの文字列を数字に変換している

### コンポーネントからAPIを利用する

cssに下記を追記する

```css title="src/styles/globals.css"
input {
  @apply border p-2 m-5 w-20;
}
```

コンポーネントから上記のAPIを使用するため、  
index.tsxを編集する。

```typescript title="src/pages/index.tsx"
'use client'
import { Inter } from 'next/font/google'
import { useState } from 'react'
import useSWR from 'swr'

const inter = Inter({ subsets:['latin']})

const urlpath = '/api/data/'
const fetcher = (...args) =>
  fetch(...args).then(res=>res.json())

export default function Home(){
  const [num, setNum] = useState(0)
  const [url, setUrl] = useState(urlpath + num)
  const {data, mutate, isLoading} = useSWR(url, fetcher)
  const doChange = (event)=>{
    const val = event.target.value
    setNum(val)
    setUrl(urlpath + val)
  }
  return (
    <main>
      <h1 className="header">Index page</h1>
      <p>これは、API利用のサンプルです。</p>
      <div>
        <input type="number" min="0" max="3"
          onChange={doChange} value={num}/>
      </div>
      <p className="border p-3">
        result: {isLoading ? "reading..."
          : JSON.stringify(data)}
      </p>
    </main>
  )
}
```

<figure markdown="span">
  ![alt text](<../../../images/7.1 PagesルーターとAPI/7.1 PagesルーターとAPI_J0133291-3.png>){width="400"}
  <figconfig>渡したidにより、reusltの表示内容が変化する</figconfig>
</figure>

idを変更するとdoChange関数が使用され,  
event.target.valueで値を取り出し、  
setNumで番号を設定し、setUrlでアクセスするパスを変更する。   
これでアクセス先が更新されて,SWRが自動的に再アクセスして表示を更新する。  

<br>

## ファイルアクセスするAPI

APIはファイルアクセスにも利用でき、Node.jsのfsモジュールを使用してファイル操作が可能  
データ読取のみではなく、ファイルへのデータ追加をする際には、POSTメソッドが使用される  
Next.jsのNextApiRequestのmethodプロパティでリクエストがGETかPOSTか判断する

### ファイルを利用するAPIを作る

```typescript title="src/pages/api/fs.ts"
import fs from 'fs'
import type { NextApiRequest, NextApiResponse } from 'next'

type Data = {
    content: string
}
const path = 'data.txt'

export default function handler(
    req: NextApiRequest,
    res: NextApiResponse<Data>
) {
    var content = ''
    switch(req.method) {
        case 'GET':
            content = fs.readFileSync(path, {flag:'a+'}).toString().trim()
            break
        case 'POST':
            const body = JSON.parse(req.body)
            fs.appendFileSync(path, body.content + "\n")
            break
        default:
            break
    }
    res.status(200).json({ content: content })
}
```

### ファイルからテキストを読み込む

```typescript title="ファイルからテキストを読み込んでいる箇所"
content = fs.readFileSync(path, {flag:'a+'}).toString().trim()
```
readFileSync：ファイルの内容読み込み
toStroing：テキストとして取り出し
trim：前後のホワイトスペース(改行等)を取り除く

### 送信されたデータを取り出し保存する

```typescript title="クライアントから送られてきたbodyコンテンツをオブジェクトとして取り出している箇所"
const body JSON.parse(req.body)
```
NextApiRequestの「body」プロパティに保管されているため、それを取り出しJSON.parseでJSONオブジェクトに変換

```typescript title="pathのファイルにbodu.contentを書き込み"
fs.appendFileSync(path, body.content + "\n")
```

<br>

## APIを利用してコンポーネントからファイルアクセスする

cssに下記を追加する

```css title="src/styles/globals.css"
.form {
  @apply p-2 m-5;
}

textarea {
  @apply border w-full;
}

button {
  @apply px-7 py-2 mx-2 bg-blue-800 text-white rounded-lg;
}

pre {
  @apply m-5 p-2;
}
```

APIを利用してコンポーネントからファイルアクセスするため、  
index.tsxを編集する  

```typescript title="src/pages/index.tsx"
'use client'
import { Inter } from 'next/font/google'
import { useState } from 'react'
import useSWR from 'swr'

const inter = Inter({ subsets: ['latin'] })

var url = '/api/fs'
const fetcher = (...args) => 
  fetch(...args).then(res => res.json())


export default function Home() {
  const [input, setInput] = useState('')
  const {data,error,mutate,isLoading} = useSWR(url, fetcher)
  
  const doChange = (event)=>{
    const val = event.target.value
    setInput(val)
  }

  const doAction = ()=> {
    const opts = {
      method:'POST',
      body:JSON.stringify({content:input})
    }
    fetch(url,opts).then(resp=>{setInput(''), mutate(url)})
  }

  return (
    <main>
      <h1 className="header">Index page</h1>
      <p>これは、API利用のサンプルです。</p>
      <div className="form">
        <textarea type="text" onChange={doChange} 
          value={input} />
        <button onClick={doAction}>Click</button>
      </div>
      <pre className="border p-3">
        {error ? 'ERROR!!' : isLoading ? 'loading...' 
          : data ? data.content : ''}
      </pre>
    </main>
  )
}
```

<figure markdown="span">
  ![alt text](<../../../images/7.1 PagesルーターとAPI/7.1 PagesルーターとAPI_J0133291-4.png>){width="300"}
  <figconfig>textareaに入力してクリックすると、data.txtに保存され、下枠に表示される</figconfig>
</figure>

mutate(url)はSWRのアクセス先を更新するために使用しており、  
指定したアクセス先にSWRを強制的にアクセスさせることができる  
初期設定と異なるURLへのアクセスや、表示を更新させる際に使用

```typescript title="mutateについて"
mutate(アクセス先)
```