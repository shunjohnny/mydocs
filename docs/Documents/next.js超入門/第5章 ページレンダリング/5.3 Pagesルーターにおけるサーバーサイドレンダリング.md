---
title: 5.3 Pagesルーターにおけるサーバーサイドレンダリング
tags:
  - Next.js
---

## ダイナミックレンダリングとは
---
ユーザーがページにアクセスするたびに、  
ページの内容がサーバー側で動的に生成される仕組みのこと  

サーバーサイドレンダリング(SSR)の最も一般的な形


| 特徴                 | SSR（Server-Side Rendering）                               | SSG（Static Site Generation）                          |
|----------------------|------------------------------------------------------------|-------------------------------------------------------|
| **データ取得<br>タイミング** | アクセスごとにサーバーで取得し<br>HTML生成                      | ビルド時に一度だけ取得し<br>静的HTML生成                   |
| **更新タイミング**      | リアルタイムで最新データを表示                             | ビルド時に固定され、<br>更新には再ビルドが必要             |
| **パフォーマンス**      | サーバー負荷が高くなる可能性がある                          | 高速でサーバー負荷が低い                               |
| **SEO効果**           | 高い（サーバーで生成されたHTMLを提供）                      | 高い（静的HTMLを直接提供）                             |
| **利用シーン**         | リアルタイムデータが必要なページ    | 変化が少ないページ   |
| **Next.jsの関数**      | getServerSideProps                                     | getStaticProps + getStaticPaths                   |

<br>

## getServerSidePropsについて
---

### getServerSidePropsの基本形

SSGで使用するgetStaticPropsと同様
```Typescript title="getServerSideProps関数の使い方"
export function getServerSideProps({params}) {
    ...処理...
    return 値
}
```

```Typescript title="プロパティとして返す値"
{
    props: {
        キー:値,
        キー:値,
        ...略...
    }
}
```

<br>

## SSRでサーバーサイドプロパティを使う
---

getServerSideProps関数を使ってSSRのページを作る
SSGの時と同様に[name].tsxを書き換える


```Typescript title="SSRの[name].tsx"
import { Inter } from 'next/font/google'
import Link from 'next/link'
import { useRouter } from 'next/router'

const inter = Inter({ subsets: ['latin']})

//ページコンポーネントの定義
export default function Name({ data }) {
    const router = useRouter()
    return (
        <main>
            <h1 className="header">{data.title}</h1>
            <p>name: {router.query.name}</p>
            <p>message: {data.msg}</p>
            <div><Link href="/">Go Back!!</Link></div>
        </main>
    )
}

//getServerSidePropsでデータを準備
export function getServerSideProps({ params }) {
    const data = {
        taro:{
            title:'Taro-web',
            msg:"This is Taro's web site."
        },
        hanako:{
            title:'ハナコの部屋',
            msg:'ここはハナコの部屋です。'
        },
        sachiko:{
            title:'サチコのページ',
            msg:'ヤッホー、サチコのページだよー'
        }
    }
    
    //params.nameが存在しない時に存在しないと出す
    if (data[params.name]) {
        return {
            props: {
                data:data[params.name]
            }
        }
    } else {
        return {
            props: {
                data:{title:"No data", msg: "データが見つかりません。"}
            }
        }
    }
}

```

<figure markdown="span">
  ![Image title](<../../../images/5.3 Pagesルーターにおけるサーバーサイドレンダリング/5.3 Pagesルーターにおけるサーバーサイドレンダリング_J0133291.png>){ width="300" }
  <figcaption>実行結果</figcaption>
</figure>

### SSRではgetStaticPathsは使えない!
SSRではページがリクエストごとに動的に生成されるため、  
事前に静的なパスを生成するgetStaticPathsが使用できない  
SSRでは「どんなパラメータが送られても対応できる」ように処理を用意すべき

<br>

## Incremental Static Regeneration (ISR)
---

|ISR|
|---|  
|ビルド時にサーバー側でデータを取得してHTMLを生成した上で、<br>指定時間経過後にリクエストがあった場合はHTMLを再生成する<br>初めはSSGでその後はSSRの動作をするという、両者のいいとこ取りのもの||

下記のようにSSGのgetStaticProps関数を利用して行う。  
revalidateは値が更新される秒数

```Typescript title="ISRの使用方法"
export function getStaticProps({ 引数}) {
    return {
        props: {値},
        revalidate: 秒数,
    }
}
```

### ISRを利用する

今までと同様に[name].tsxを書き換えて、ISRの動作を確認する。

```Typescript title="ISRの[name].tsx"
import { Inter } from 'next/font/google'
import Link from 'next/link'
import { useRouter } from 'next/router'

const inter = Inter({ subsets: ['latin']})

//ページコンポーネントの定義
export default function Name({ data }) {
    console.log("start component.")
    const router = useRouter()
    return (
        <main>
            <h1 className="header">{data.title}</h1>
            <p>name: {router.query.name}</p>
            <p>message: {data.msg}</p>
            <div><Link href="/">Go Back!!</Link></div>
        </main>
    )
}

//初期値
var data = {
    taro:{
        title:'Taro-web',
        msg:"This is Taro's web site."
    },
    hanako:{
        title:'ハナコの部屋',
        msg:"ここは、ハナコの部屋です。"
    },
    sachiko:{
        title:'サチコのページ',
        msg:'ヤッホー、サチコのページだよー!'
    }
}

//静的パスの生成
export function getStaticPaths() {
    const path = [
        '/name/taro',
        '/name/hanako',
        '/name/sachiko'
    ]
    return {
        paths:path,
        fallback: false
    }
}

//ISRの設定
export function getStaticProps({ params }) {
    console.log("getStaticProps")
    return {
        props: {
            data:data[params.name]
        },
        revalidate: 15
    }
}

//データの定期更新
setInterval(() => {
    const d =new Date().toISOString()
    data = {
        taro:{
          title:'タロー',
          msg:'たろーさんです。(' + d + ')'
        },
        hanako:{
          title:'ハナコ～',
          msg:'ハナコさんです～～。(' + d + ')'
        },
        sachiko:{
          title:'サチコ～',
          msg:'サチコ～です～。(' + d + ')'
        }
    }
    console.log("setInterval")
}, 5000)
```

|初期アクセス|数秒後|
|---|---|
|![alt text](<../../../images/5.3 Pagesルーターにおけるサーバーサイドレンダリング/5.3 Pagesルーターにおけるサーバーサイドレンダリング_J0133291-1.png>)|![alt text](<../../../images/5.3 Pagesルーターにおけるサーバーサイドレンダリング/5.3 Pagesルーターにおけるサーバーサイドレンダリング_J0133291-2.png>)|

!!! note
    npm run devでは正しく確認できないので、npm run build後にnpm startで確認する必要あり

### ISRの動作を確認する
ISRを利用することで、通常は静的ページとして表示されるが、  
15秒ごとに再生成され、データが更新される。  
これは毎回SSRでレンダリングしているわけではなく、  
指定の感覚で静的ページが再生成されることを意味する。  
getStaticPropsが15秒ごとに実行され、データはそれに応じて更新されるため、  
表示が変化することが確認できる。

<br>

## Pagesルーターのレンダリングは複雑
---

使い分けを理解することが大切

| レンダリング方法 | 説明                                                                                          | 使用する関数                     |
|---------------|---------------------------------------------------------------------------------------------|----------------------------------|
| SSG<br>（Static Site Generation）    | ページをビルド時に静的に生成、<br>変更がない限り同じHTMLを提供                                | getStaticProps <br>+getStaticPaths         |
| SSR<br>（Server Side Rendering） | リクエストごとにサーバーでページを生成、<br>常に最新のデータを提供                 | getServerSideProps          |
| ISR<br>（Incremental Static Regeneration） | 一定時間ごとに静的ページを再生成、<br>更新頻度の少ないページに最新データを反映  | getStaticProps <br>+revalidate  |

