---
title: 6.3 SWRによるネットワークアクション
tags:
  - Next.js
---


## fetchからSWRへ

サーバーコンポーネントではデータ取得が簡単だが、  
クライアントコンポーネントではfetchを使用した更新が必要で複雑になりがち  
↓  
SWRを使用して自動更新やエラーハンドリングでデータ取得を簡素化  

|SWR|
|---|
|SWR は、React 用のデータ取得ライブラリ<br>Stale-While-Revalidate(古くなったもの-間-再検証)の略<br>クライアントサイドでのデータフェッチをシンプルにするために使用|

### SWRをインストールする

プロジェクトのディレクトリに移動して下記コマンドで  
powershellにてインストール  

```powershell title="SWRのインストール"
npm install swr
```

<br>

## SWRの基本

```Typescript title="SWRの基本の使用方法"
//useSWRはSWRを利用するためのフック
import useSWR from 'swr'

//useSWRの基本形
const {data, error, mutate, isLoading} = useSWR(アドレス, 《fetcher》, オプション)
```

下記の4つが、useSWRの戻り値

| 名前       | 説明                                       |
|-----------|--------------------------------------------|
| data      | 取得したデータが保管される                    |
| error     | エラー発生時の情報が渡される                  |
| mutate    | 更新用の関数。これを呼び出すことで強制的に更新 |
| isLoading | ロード中かどうかを示す boolean 値            |


### fetcherについて

useSWR関数には、データ取得用の関数fetcherの指定が必要
fetcherはデータへのアクセスに使われ、サーバーからデータを取得する場合fetchを使用
下記のまま覚えて置けばOK

```Typescript title="テキストを取得するfetcher関数"
(...args) => fetch(...args).then(res => res.text())
```

```Typescript title="JSONオブジェクトを取得するfetcher関数"
(...args) => fetch(...args).then(res => res.json())
```

<br>

## sample.jsonのメッセージを表示する

SWRを使用して、sample.jsonファイルからmessageを取得して表示する

```Typescript title="src/app/page.tsx"
"use client"
import useSWR from 'swr'

const url = '/sample.json'

//Jsonオブジェクトを取得するfetcher関数
const fetcher = (...args) =>
  fetch(...args).then(res => res.json())

export default function Home() {
  const {data,error,isLoading} = useSWR(url, fetcher) //useSWRを使用してurlのデータをフェッチ

  function doSWR() {
    if (error) return <p>ERROR!!</p>                  //エラー発生時の表示
    if (isLoading) return <p>isLoading...</p>         //ロード中の表示
    return <p>{data.message}</p>                      //それ以外の表示
  }

  return (
    <main>
      <h1 className="title">Index page</h1>
      <p className="mag font-bold">※SWRでデータを取得します</p>
      <div className="border p-2 m-5">{doSWR()}</div>
    </main>
  )
```

<br>

## データアイテムをコンポーネント化する

取得するデータの項目が確認できたほうが分かりやすいので、  
項目を表示するコンポーネントを作成する

その前に項目用のcssを追加する

```css title="src/app/grobal.css"
table {
  @apply m-5;
}

table tr th {
  @apply border-solid border-2 bg-blue-100 px-10;
}

table tr td {
  @apply border-solid border-2 p-2;
}
```

### データ用コンポーネント

```Typescript title="src/app/JsonItem.tsx"
"use client"

export default function JsonItem(props) {
    return (
        <tr>
            <td>{props.data.name}</td>
            <td>{props.data.mail}</td>
            <td>{props.data.age}</td>
        </tr>
    )
}
```

### JsonItemコンポーネントでデータを表示する

```Typescript title="src/app/page.tsx"
"use client"
import JsonItem from './JsonItem'
import useSWR from 'swr'

const url = '/sample.json'
const fetcher = (...args) =>
  fetch(...args).then(res => res.json())

export default function Home() {
  const {data,error,isLoading} = useSWR(url, fetcher) 

  //データの各アイテムをJsonItemコンポーネントに渡し、表示する関数
  const doItem = (value) =>{
    return <JsonItem data={value} />
  }

  return (
    <main>
      <h1 className="title">Index page</h1>
      <p className="mag font-bold">※SWRでデータを取得します</p>
      <table>
        <thead>
          <tr>
            <th>name</th>
            <th>mail</th>
            <th>age</th>
          </tr>
        </thead>
        <tbody>
          {data ? data.data.map((value)=>doItem(value))
            : <tr><td>-</td><td>-</td><td>-</td></tr>}
        </tbody>
      </table>
    </main>
  )
}
```

<figure markdown="span">
  ![alt text](<../../../images/6.3 SWRによるネットワークアクセス/6.3 SWRによるネットワークアクセス_J0133291.png>){width="400"}
  <figcaption>実行結果</figcaption>
</figure>

### コードの解説

```Typescript title="doItem関数を使用し、JSX内にdataのデータをJsonItemコンポーネントとして組み込んでいる箇所"
{data ? data.data.map((value)=>doItem(value))
  : <tr><td>-</td><td>-</td><td>-</td></tr>}
```

```typescript title="上の箇所でやっていること"
data ? 値がある時の内容 : 値が無い時の内容
```

dataの値がない時は空欄を表示するようにしている

```typescript title="mapメソッドは、配列の値を順に取り出して行う際に使用"
配列.map(引数=>内容)
```

<br>

## サーバー側でSWRを利用する

SWRはクライアントサイトでのデータ取得で使用できるが、  
サーバーコンポーネントでは使用不可  
しかし、Next.jsでは組み合わせにより、サーバーサイドでもSWRの自動更新が使用可能に

### SWR利用コンポーネントの作成

SWRを使用してsample.jsonにアクセスし、データを取得、messageを表示

```typescript title="src/app/GetData.tsx"
'use client'
import useSWR from 'swr'

const url = '/sample.json'
const fetcher = (...args) => 
    fetch(...args).then(res => res.json())

export default function GetData() {
    const {data, error, isLoading} = useSWR(url, fetcher)
    return (
        data ?
          <p className="msg border p-2">{data.message}</p>
          : <p className="msg border p-2">nodata</p>
    )
}
```

### プロバイダーコンポーネントの設計

|SWRProvider|
|---|
|SWRの設定をアプリ全体で共有するためのコンポーネント|

下記のchildrenは、SWRProviderで囲まれた中身のコンポーネントや要素を受取、  
SWRConfigに適用している  
これでどこからでも同じ設定でデータ取得ができる

```typescript title="src/app/swr-provider.tsx"
'use client'
import { SWRConfig } from 'swr'

export const SWRProvider = ({ children }) => {
    return <SWRConfig>{children}</SWRConfig>
}
```

### サーバーコンポーネントにSWR利用コンポーネントを埋め込む

サーバーコンポーネント内に
クライアントコンポーネントであるGetDataを埋め込んでも動く  
↓  
上記で作成したSWRProviderの内部で  
SWRを使用したクライアントコンポーネントが独立して動くため

```typescript title="src/app/page.tsx"
"use server"
import { SWRProvider } from './swr-provider'
import GetData from './GetData'

export default async function Home() {
  return (
    <main>
      <h1 className="title">Index page</h1>
      <p className="msg font-bold">※SWRでデータを取得します</p>
      <SWRProvider>
        <GetData />
      </SWRProvider>
    </main>
  )
}
```

<figure markdown="span">
  ![alt text](<../../../images/6.3 SWRによるネットワークアクセス/6.3 SWRによるネットワークアクセス_J0133291-1.png>){width="400"}
  <figcaption>実行結果</figcaption>
</figure>