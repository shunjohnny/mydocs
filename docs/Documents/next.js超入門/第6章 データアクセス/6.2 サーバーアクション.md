---
title: 6.2 サーバーアクション
tags:
  - Next.js
---

## サーバーアクションについて
---
### コンポーネントとサーバーアクション

|サーバーアクション|
|---|
|サーバーアクションとは、Next.jsでサーバー側処理を行うための関数<br>データベースアクセスやファイル操作をクライアントやサーバーコンポーネントから簡単に呼び出せる仕組み<br>exportして"use server"を指定することで、サーバー側で確実に実行される|

Reactのクライントコンポーネントでは、  
onClickやonChange等のイベントを利用してクライント側で処理が行われるが、  
ファイル操作やデータベースアクセス等、サーバー側で実行したい際に使用する。

<figure markdown="span">
  ![Image title](<../../../images/6.2 サーバーアクション/6.2 サーバーアクション_J0133291.png>){ width="300" }
  <figcaption>サーバーアクションのイメージ図</figcaption>
</figure>

<br>

## サーバーアクションを利用する
---
src/app/server-action.tsxを作成  
サーバーアクションの関数を書き込む  
ここでは前節と同様fetch関数でsample.jsonからmessageのテキストを取り指す関数を使用

```Typescript title="サーバーアクションの関数 src/app/server-action.tsx"
"use server"
const url = 'http://localhost:3000/sample.json'

export async function serverAction() {
    const resp = await fetch(
        url,
        { cache: 'no-store'}
    )
    const result = await resp.json()
    console.log("Get message!")
    console.log(result.message)
}
```

### コンポーネントからサーバーアクションを呼び出す

src/app/page.tsxを編集する

```Typescript title="サーバーアクションを呼び出すコンポーネント src/app/page.tsx"
"use server"

import {serverAction} from './server-action'

export default async function Home() {
    return(
    <main>
      <h1 className="title">Index page</h1>
      <p className="msg">ボタンをクリックしてください</p>
      <div>
        <form action={serverAction}>
          <button className="btn">Click</button>
        </form>
      </div>
    </main>
    )
}
```

|立ち上がるページ|クリック後のターミナル|
|---|---|
|![alt text](<../../../images/6.2 サーバーアクション/6.2 サーバーアクション_J0133291-1.png>)|![alt text](<../../../images/6.2 サーバーアクション/6.2 サーバーアクション_J0133291-2.png>)|

!!! warning
    サーバーアクションの呼び出しはformのactionを使用する<br>`<button>`等のonClickに設定するとエラーが発生する

<br>

## フォームの送信
---

実用的な例として、  
フォームの内容をサーバーアクションに送り、  
それを受け取って処理するようにする

src/app/page.tsxを編集する

```Typescript title="数字を入力できるように変更したコンポーネント src/app/page.tsx"
"use server"
import {serverAction} from './server-action'

export default async function Home() {
  return (
    <main>
      <h1 className="title">Index page</h1>
      <p className="msg">※数字を入力してください。</p>
      <div>
        <form className="form" action={serverAction}>
          <input className="input" type="number" name="input"/>
          <button className="btn">Click</button>
        </form>
      </div>
    </main>
  )
}
```

### サーバーアクションの修正

フォームから入力を取得し、ユーザーをデータ付きのURLにリダイレクトする。

```Typescript title="サーバーアクションのコンポーネント src/app/server-action.tsx"
"use server"

import { redirect } from 'next/navigation'

const url = 'http://localhost:3000/sample.json'

export async function serverAction(form) {
    const num = form.get("input")
    const resp = await fetch(
        url,
        { cache: 'no-store'}
    )
    const result = await resp.json()
    let data = result.data[num]
    if (data == null) {
        data = {name:'-', mail:'-', age:0}
    }

    const query = 'name=' + data.name + '&mail=' + data.mail + '&age=' + data.age //クエリ文字列作成
    const searchParams = new URLSearchParams(query)  //URLSearchParamsを使用し、クエリパラメータを整形
    redirect('/other?' + searchParams.toString())    //新しいURLにリダイレクト
```

### リダイレクト先の用意

リダイレクト先のコンポーネントを用意する。

```Typescript title="リダイレクト先のコンポーネント src/app/other/page.tsx"
"use client"
import Link from 'next/link'
import { useSearchParams } from 'next/navigation'

export default function Other() {
  const params = useSearchParams()
  return (
    <main>
      <h1 className="title">Other page</h1>
      <p className="msg">フォームが送信されました。
        以下のデータを取得しました。</p>
      <ol>
        <li className="msg">Name: {params.get('name')}</li>
        <li className="msg">Mail: {params.get('mail')}</li>
        <li className="msg">Age: {params.get('age')}</li>
      </ol>
      <div>
        <a href="/">go back!!</a>
      </div>
    </main>
  )
}
```

|入力フォーム|実行結果|
|---|---|
|![alt text](<../../../images/6.2 サーバーアクション/6.2 サーバーアクション_J0133291-5.png>)|![alt text](<../../../images/6.2 サーバーアクション/6.2 サーバーアクション_J0133291-3.png>)|

<br>

## ファイルアクセスを行う
---

Next.js アプリケーションは Node.js ベースなので、  
サーバーサイドではNode.jsのfsモジュールを使ったファイル操作が可能

```Tyepscript title="ファイルからテキストを読み込む"
変数 = fs.readFileSync(ファイルパス, エンコード)
```

```Tyepscript title="ファイルにテキストを書き出す"
fs.writeFileSync(ファイルパス, 値)
```

```Tyepscript title="ファイルにテキストを追記する"
fs.appendFileSync(ファイルパス, 値)
```

これらは同期的に動作するが、非同期で動作するメソッドもあり、  
末尾の「Sync」を外した名前で利用可

### ファイルアクセスするサーバーアクション

上記のファイルアクセス機能を使用したサンプルコード。  
./data.txtに入力した値を書き込む

```Typescript title='src/app/server-action.tsx'
"use server"

import {redirect} from 'next/navigation'
import fs from 'fs'

const fname = './data.txt'

// formデータを受け取ってinputに格納して、
// appendFileSyncでファイルに内容を書き込み
export async function serverAction(form) {
    const input = form.get("input")
    fs.appendFileSync(fname, input + "\n")
    redirect('/other')
}

// fnameの内容をreadFileSyncで読み込む
export async function readData() {
    return fs.readFileSync(fname, 'utf8')
}
```

## コンポーネントからアクセスする
---

上記のフォームの送信で行ったものを  
数字入力からテキスト入力に改修

```Typescript title="src/app/page.tsx"
"use server"
import {serverAction} from './server-action'

export default async function Home() {
  return (
    <main>
      <h1 className="title">Index page</h1>
      <p className="msg">※メッセージを送信：</p>
      <div>
        <form className="form" action={serverAction}>
          <input className="input" type="text" name="input"/>
          <button className="btn">Click</button>
        </form>
      </div>
    </main>
  )
}
```

### Otherでテキストを表示する

リダイレクト先のOtherコンポーネントを編集して、  
data.txtに書かれている内容を表示する。

```Typescript title="src/app/other/page.tsx"
"use server"

import Link from 'next/link'
import {readData} from '../server-action'

export default async function Other() {
  const data = await readData()
  return (
    <main>
      <h1 className="title">Other page</h1>
      <p className="msg">メッセージを保存しました。</p>
      <pre className="m-5 p-2 border">{data}</pre>
      <div>
        <a href="/">go back!!</a>
      </div>
    </main>
  )
}
```

|クリック前|クリック後|
|---|---|
|![alt text](<../../../images/6.2 サーバーアクション/6.2 サーバーアクション_J0133291-4.png>)|![alt text](<../../../images/6.2 サーバーアクション/6.2 サーバーアクション_J0133291-6.png>)|

### クライアントコンポーネントの場合は？

上記のサーバーサイドでおこなったものをクライアントサイドで行うように変更する  
reactの機能を利用し、  
useEffectフックを使用して、ページのマウント後、  
readDataが呼ばれ、データを取得してsetDataでdataステートを更新

```Typescript title="src/app/other/page.tsx"
"use client"
import Link from 'next/link'
import {readData} from '../server-action'
import {useState,useEffect} from 'react'

export default function Other() {
  const [data, setData] = useState('nodata')
  useEffect(()=>{
    readData().then(res=>{
      setData(res)
    })
  },[])
  return (
    <main>
      <h1 className="title">Other page</h1>
      <p className="msg">メッセージを保存しました。</p>
      <pre className="m-5 p-2 border">{data}</pre>
      <div>
        <a href="/">go back!!</a>
      </div>
    </main>
  )
}
```