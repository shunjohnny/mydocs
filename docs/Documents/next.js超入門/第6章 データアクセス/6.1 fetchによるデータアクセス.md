---
title: 6.1 fetchによるデータアクセス
tags:
  - Next.js
---

## データを利用するには？
---

データの取得にはfetchを使用する。  
Next.jsではクライアント側、サーバー側の両方で動作する。

```Typescript title="fetch関数の呼び出し1"
変数 = await fetch(アドレス, オプション)
```

```Typescript title="fetch関数の呼び出し2"
fetch(アドレス, オプション).then(引数=> {...後処理...})
```
<br>

fetchの戻り値はResponseというオブジェクト。  
ここから必要なメソッドを呼び出し、返されたデータを取り出す。
```Typescript title="テキストデータとして取得"
《Response》.text()
```

```Typescript title="JSONオブジェクトとして取得"
《Response》.json()
```

### オプション引数について
fetch関数「fetch(アドレス、オプション)」では、  
第1引数にアクセスするアドレスをstringを渡す  
第2引数にオプションの設定となる値をまとめたオブジェクトを渡す  

|オプション引数|説明|
|---|---|
|force-cache|値を強制的にキャッシュ|
|no-store|値を保管しない、アクセスの度取得する|

<br>

## JSONデータを用意する
---

練習 : fetchで取ってくるsample.jsonファイルを作成

```json title="public/sample.json"
{
    "message":"これはサンプルのデータです。",
    "data":[
        {"name":"taro","mail":"taro@yamada","age":"39"},
        {"name":"hanako","mail":"hanako@yamada","age":"28"},
        {"name":"sachiko","mail":"sachico@yamada","age":"17"}
    ]
}
```

<br>

## サーバーコンポーネントからfetchする
---

src/app/page.tsxを編集する

```Typescript title="fetchを使用して、sample.jsonからデータを取得"
"use server"

const url = 'http://localhost:3000/sample.json'

async function getSampleData() {             
  const resp = await fetch(                  //fetch関数を呼び出してJSONデータを取得
    url,
    { cache: 'no-store' }
  )
  const result = await resp.json()           //respに格納された戻り値からJSONオブジェクトを取得して返す
  return result
}

export default async function Home() {
  const data = await getSampleData()         //JSONデータのオブジェクトがdataに取り出される。関数が非同期だからawaitをつける
  return (
    <main>
      <h1 className="title">Index page</h1>
      <p className="msg">{data.message}</p>
    </main>
  )
}
```

<figure markdown="span">
  ![Image title](<../../../images/6.1 fetchによるデータアクセス/6.1 fetchによるデータアクセス_J0133291.png>){ width="300" }
  <figcaption>実行結果</figcaption>
</figure>

<br>

## クライアントコンポーネントからfetchする
---

!!! note
    クライアントコンポーネントは、<br>ブラウザ側でレンダリングされ、ユーザーとのインタラクションをサポートするReactコンポーネントを指す

src/app/page.tsxを編集する

```Typescript title="クライアントコンポーネントからfetchする"
"use client"
import {useState} from 'react'

const url = 'http://localhost:3000/sample.json'

// 非同期関数で、指定されたURLからJSONデータをfetchし、そのデータを返す
async function getSampleData() {
  const resp = await fetch(
    url,
    { cache: 'no-store' }
  )
  const result = await resp.json()
  return result
}

// Reactコンポーネント
export default function Home() {
  const [msg, setMsg] = useState('dummy message.')   //msgという状態変数を定義
  const doChange = (event) => {                      //入力フォオームの値を更新するイベントハンドラ。未使用
    setInput(event.target.value)
  }
  function doAction() {                              //ボタンクリック時にgetSampleDataを呼び出し、取得したデータのmessageプロパティをmsgにセット
    getSampleData().then(resp=> {
      setMsg(resp.message)
    })
  }


  return (
    <main>
      <h1 className="title">Index page</h1>
      <p className="msg">{msg}</p>
      <div className="form">
        <button className="btn" onClick={doAction}>Click</button>
      </div>
    </main>
  )
}
```

|クリックする前|クリック後|
|---|---|
|![alt text](<../../../images/6.1 fetchによるデータアクセス/6.1 fetchによるデータアクセス_J0133291-1.png>)|![alt text](<../../../images/6.1 fetchによるデータアクセス/6.1 fetchによるデータアクセス_J0133291-2.png>)|

APPルーターでは下記のように同期、非同期を使い分けることが必要  
サーバーコンポーネント関数 : 非同期    
クライアントコンポーネント関数 : 同期  
↓  
getSampleDataではawaitが使用できず、  
thenを使用してコールバック関数を定義し、その中で処理する必要

```Typescript title="コールバック関数の処理"
resp=>{
  setMsg(resp.message)
}
```