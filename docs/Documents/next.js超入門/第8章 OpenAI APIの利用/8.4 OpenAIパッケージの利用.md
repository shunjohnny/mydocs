---
title: 8.4 OpenAIパッケージの利用
tags:
  - Next.js
---

## OpenAIのNode.jsパッケージ

OpenAIが提供するNode.js用のパッケージを利用してOpenAI APIにアクセスする。  
ただし、サーバー側のみで使用でき、クライアント側では使用できない。

```bash title="OpenAIのパッケージをインストール"
npm install openai
```

## OpenAI利用のAPIを作る

```typescript title="src/app/rh/route.ts"
"use server"
import OpenAI from "openai"

const api_key = 'APIキーをここに入力してください'
const openai = new OpenAI({apiKey: api_key});

export async function GET(request: Request) {
    return new Response(JSON.stringify({content:'nodata.'}),{
        status: 200,
        headers: { 'Content-Type': 'application/json' },
    })
}

export async function POST(request: Request) {
    const input = await request.json()
    const messages = [
        {
            role: "user",
            content: input.prompt
        }
    ]
    const resp = await openai.chat.completions.create({
        messages: messages,
        model: "gpt-3.5-turbo"
    })
    const message = resp.choices[0].message;
    const res = {content:message.content.trim()}
    return new Response(JSON.stringify(res), {
        status: 200,
        headers: { 'Content-Type': 'application/json' },
    })
}

```

## APIにアクセスするコンポーネントを作成する

```typescript title="src/app/pages.tsx"
"use client"
import { useState } from 'react'

export default function Home() {
  const [input,setInput] = useState('')
  const [prompt,setPrompt] = useState('')
  const [assistant,setAssistant] = useState('')
  
  const doChange = (event)=> {
    setInput(event.target.value)
  }

  async function doAction() {
    setAssistant('wait...')
    fetch('/rh', {
      method: 'POST', 
      body: JSON.stringify({prompt:input})
    })
      .then(resp => resp.json())
      .then((value)=> {
        setPrompt(input)
        setInput('')
        setAssistant(value.content)
      })
      .catch(error => {
        console.log(error)
      });
  }
  
  return (
    <main>
      <h1 className="title">Index page</h1>
      <p className="msg font-bold">
        プロンプトを入力：</p>
        <div className="m-5">
          <input type="text" className="input" name="input" 
            onChange={doChange} value={input} />
          <button className="btn" onClick={doAction}>Send</button>
        </div>
      <div className="prompt">
      <p className="">PROMPT: {prompt}</p>
      <p className="">ASSISTANT: {assistant}</p>
      </div>
    </main>
  )
}
```

## イメージ生成APIを利用する


```typescript title="src/app/rh/route.ts"
"use server"
import OpenAI from "openai"


const api_key = 'APIキーをここに入力してください'
const openai = new OpenAI({apiKey: api_key});

export async function GET(request: Request) {
    return new Response(JSON.stringify({content:'nodata.'}),{
        status: 200,
        headers: { 'Content-Type': 'application/json' },
    })
}

export async function POST(request: Request) {
    const input = await request.json()  
    const opts = {
      prompt: input.prompt,
      n: 1,
      size: '256x256'
    }
    const image = await openai.images.generate(opts)
    const url = image.data[0].url
    return new Response(JSON.stringify({url:url}), {
      status: 200,
      headers: { 'Content-Type': 'application/json' },
    })
  }

```

```typescript title="src/app/pages.tsx"
"use client"
import { useState } from 'react'

export default function Home() {
  const [input,setInput] = useState('')
  const [prompt,setPrompt] = useState('')
  const [src,setSrc] = useState('/noimage.png')
  
  const doChange = (event)=> {
    setInput(event.target.value)
  }

  async function doAction() {
    setPrompt('wait...')
    fetch('/rh', {
      method: 'POST', 
      body: JSON.stringify({prompt:input})
    })
      .then(resp => resp.json())
      .then((value)=> {
        setPrompt(input)
        setInput('')
        setSrc(value.url)
      })
      .catch(error => {
        console.log(error)
      });
  }

  return (
    <main>
      <h1 className="title">Index page</h1>
      <p className="msg font-bold">
        プロンプトを入力：</p>
      <div className="mx-5">
        <input type="text" className="input"
          value={input} onChange={doChange}/>
        <button className="btn" onClick={doAction}>
          Send</button>
      </div>
      <div className="prompt">
      <div>PROMPT: {prompt}</div>
        <div>
          <a href={src} target="_blank">
            <img className="my-0" width="256" height="256" src={src} />
          </a>
        </div>
      </div>
    </main>
  )
}
```